# ===========================================
# Market Intelligence Platform
# Docker Compose - Cloud Deployment (AWS/GCP)
# ===========================================
# 
# Para AWS ECS:
#   docker context create ecs myecs
#   docker context use myecs
#   docker compose -f docker-compose.cloud.yml up
#
# Para GCP Cloud Run:
#   gcloud run deploy mi-backend --source ./backend
#   gcloud run deploy mi-frontend --source ./frontend
# ===========================================

version: '3.9'

# AWS ECS / Fargate Configuration
x-aws-vpc: &aws-vpc
  x-aws-vpc:
    vpc: ${AWS_VPC_ID}
    subnets:
      - ${AWS_SUBNET_1}
      - ${AWS_SUBNET_2}

services:
  # =========================================
  # BACKEND - FastAPI (AWS Fargate)
  # =========================================
  backend:
    image: ${AWS_ACCOUNT_ID}.dkr.ecr.${AWS_REGION}.amazonaws.com/mi-backend:latest
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 4096M
      replicas: 2
      labels:
        - "ecs.task-definition-family=mi-backend"
        - "ecs.service.desired-count=2"
        - "ecs.service.launch-type=FARGATE"
    x-aws-autoscaling:
      min: 2
      max: 10
      cpu: 70
    environment:
      - ENVIRONMENT=production
      - DEBUG=false
      - LOG_LEVEL=INFO
      # Secrets from AWS Secrets Manager
      - ANTHROPIC_API_KEY_ARN=${ANTHROPIC_SECRET_ARN}
      - GOOGLE_API_KEY_ARN=${GOOGLE_SECRET_ARN}
      - FINNHUB_API_KEY_ARN=${FINNHUB_SECRET_ARN}
      # AWS Services
      - REDIS_URL=${ELASTICACHE_URL}
      - DATABASE_URL=${RDS_URL}
      - S3_BUCKET=${S3_BUCKET}
      - AWS_REGION=${AWS_REGION}
    ports:
      - target: 8000
        x-aws-protocol: http
    x-aws-logs_retention: 30
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

  # =========================================
  # FRONTEND - React (AWS Fargate)
  # =========================================
  frontend:
    image: ${AWS_ACCOUNT_ID}.dkr.ecr.${AWS_REGION}.amazonaws.com/mi-frontend:latest
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 1024M
      replicas: 2
    x-aws-autoscaling:
      min: 2
      max: 5
      cpu: 70
    environment:
      - REACT_APP_API_URL=https://${API_DOMAIN}
    ports:
      - target: 80
        x-aws-protocol: http
    x-aws-logs_retention: 14
    depends_on:
      - backend

x-aws-cloudformation:
  Resources:
    # Application Load Balancer
    LoadBalancer:
      Type: AWS::ElasticLoadBalancingV2::LoadBalancer
      Properties:
        Type: application
        Scheme: internet-facing

    # Certificate for HTTPS
    Certificate:
      Type: AWS::CertificateManager::Certificate
      Properties:
        DomainName: ${DOMAIN_NAME}
        ValidationMethod: DNS

networks:
  default:
    name: mi-cloud-network
